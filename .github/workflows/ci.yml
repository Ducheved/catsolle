name: CI/CD

on:
  push:
    branches: [main]
    tags: ["v*"]
  pull_request:
    branches: [main]

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # ============================================
  # CI: Format, Lint, Test, Docs
  # ============================================
  ci:
    name: CI (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2

      - name: Check formatting
        run: cargo fmt --all -- --check

      - name: Clippy
        run: cargo clippy --workspace --all-targets -- -D warnings

      - name: Run tests
        run: cargo test --workspace --all-features

      - name: Build docs
        run: cargo doc --workspace --no-deps

  # ============================================
  # Build: Create binaries for all platforms
  # ============================================
  build:
    name: Build (${{ matrix.target }})
    needs: ci
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v')
    runs-on: ${{ matrix.os }}
    env:
      CARGO_TARGET_DIR: target/${{ matrix.target }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-latest
            archive: tar.gz
          - target: aarch64-unknown-linux-gnu
            os: ubuntu-latest
            archive: tar.gz
            cross: true

          # Windows
          - target: x86_64-pc-windows-msvc
            os: windows-latest
            archive: zip
          - target: aarch64-pc-windows-msvc
            os: windows-latest
            archive: zip

          # macOS
          - target: x86_64-apple-darwin
            os: macos-latest
            archive: tar.gz
          - target: aarch64-apple-darwin
            os: macos-latest
            archive: tar.gz

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install cross (Linux ARM)
        if: matrix.cross
        run: cargo install cross --git https://github.com/cross-rs/cross

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2

      - name: Build (native)
        if: "!matrix.cross"
        run: cargo build --release --target ${{ matrix.target }}

      - name: Build (cross)
        if: matrix.cross
        run: cross build --release --target ${{ matrix.target }}

      - name: Prepare artifacts (Unix)
        if: runner.os != 'Windows'
        run: |
          mkdir -p dist
          if [ -f "${CARGO_TARGET_DIR}/${{ matrix.target }}/release/catsolle" ]; then
            cp "${CARGO_TARGET_DIR}/${{ matrix.target }}/release/catsolle" dist/
          elif [ -f "${CARGO_TARGET_DIR}/release/catsolle" ]; then
            cp "${CARGO_TARGET_DIR}/release/catsolle" dist/
          else
            cp "target/${{ matrix.target }}/release/catsolle" dist/
          fi
          cp README.md LICENSE* dist/ 2>/dev/null || true
          cd dist
          tar -czvf ../catsolle-${{ matrix.target }}.${{ matrix.archive }} *

      - name: Prepare artifacts (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path dist
          if (Test-Path "$env:CARGO_TARGET_DIR/${{ matrix.target }}/release/catsolle.exe") {
            Copy-Item "$env:CARGO_TARGET_DIR/${{ matrix.target }}/release/catsolle.exe" dist/
          } elseif (Test-Path "$env:CARGO_TARGET_DIR/release/catsolle.exe") {
            Copy-Item "$env:CARGO_TARGET_DIR/release/catsolle.exe" dist/
          } else {
            Copy-Item "target/${{ matrix.target }}/release/catsolle.exe" dist/
          }
          Copy-Item README.md dist/ -ErrorAction SilentlyContinue
          Copy-Item LICENSE* dist/ -ErrorAction SilentlyContinue
          Compress-Archive -Path dist/* -DestinationPath catsolle-${{ matrix.target }}.zip

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: catsolle-${{ matrix.target }}
          path: catsolle-${{ matrix.target }}.${{ matrix.archive }}

  # ============================================
  # Windows Installer (MSI)
  # ============================================
  windows-installer:
    name: Windows Installer
    needs: build
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download Windows x64 artifact
        uses: actions/download-artifact@v4
        with:
          name: catsolle-x86_64-pc-windows-msvc

      - name: Extract binary
        shell: pwsh
        run: |
          Expand-Archive -Path catsolle-x86_64-pc-windows-msvc.zip -DestinationPath extracted

      - name: Install WiX Toolset
        run: dotnet tool install --global wix

      - name: Create WiX source
        shell: pwsh
        run: |
          @"
          <?xml version="1.0" encoding="UTF-8"?>
          <Wix xmlns="http://wixtoolset.org/schemas/v4/wxs">
            <Package Name="catsolle"
                     Manufacturer="catsolle"
                     Version="0.1.0"
                     UpgradeCode="6E3969B5-3C8E-4E3A-B8F5-C5D7E8F9A0B1">
              <MajorUpgrade DowngradeErrorMessage="A newer version is already installed." />
              <MediaTemplate EmbedCab="yes" />
              <Feature Id="Main" Level="1">
                <ComponentGroupRef Id="ProductComponents" />
                <ComponentRef Id="PathEnv" />
              </Feature>
              <StandardDirectory Id="ProgramFiles64Folder">
                <Directory Id="INSTALLFOLDER" Name="catsolle">
                  <Component Id="MainExecutable" Guid="7E4A69B5-4C9E-5E4A-C9F6-D6E8F9A0B2C3">
                    <File Id="catsolle.exe" Source="extracted\catsolle.exe" KeyPath="yes" />
                  </Component>
                </Directory>
              </StandardDirectory>
              <ComponentGroup Id="ProductComponents" Directory="INSTALLFOLDER">
                <ComponentRef Id="MainExecutable" />
              </ComponentGroup>
              <Component Id="PathEnv" Guid="8F5B7AC6-5DAF-6F5B-DA67-E7F9GAB1C3D4" Directory="INSTALLFOLDER">
                <Environment Id="PATH" Name="PATH" Value="[INSTALLFOLDER]" Permanent="no" Part="last" Action="set" System="yes" />
              </Component>
            </Package>
          </Wix>
          "@ | Out-File -FilePath installer.wxs -Encoding UTF8

      - name: Build MSI
        run: wix build installer.wxs -o catsolle-x86_64-windows.msi

      - name: Upload MSI
        uses: actions/upload-artifact@v4
        with:
          name: catsolle-windows-installer
          path: catsolle-x86_64-windows.msi

  # ============================================
  # macOS App Bundle
  # ============================================
  macos-bundle:
    name: macOS Bundle
    needs: build
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download macOS artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: catsolle-*-apple-darwin
          merge-multiple: true

      - name: Create universal binary and DMG
        run: |
          # Extract binaries
          mkdir -p x86_64 aarch64
          tar -xzf catsolle-x86_64-apple-darwin.tar.gz -C x86_64
          tar -xzf catsolle-aarch64-apple-darwin.tar.gz -C aarch64

          # Create universal binary
          mkdir -p catsolle.app/Contents/MacOS
          mkdir -p catsolle.app/Contents/Resources
          lipo -create x86_64/catsolle aarch64/catsolle -output catsolle.app/Contents/MacOS/catsolle
          chmod +x catsolle.app/Contents/MacOS/catsolle

          # Create Info.plist
          cat > catsolle.app/Contents/Info.plist << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>CFBundleExecutable</key>
              <string>catsolle</string>
              <key>CFBundleIdentifier</key>
              <string>com.catsolle.app</string>
              <key>CFBundleName</key>
              <string>catsolle</string>
              <key>CFBundleVersion</key>
              <string>0.1.0</string>
              <key>CFBundleShortVersionString</key>
              <string>0.1.0</string>
              <key>LSMinimumSystemVersion</key>
              <string>10.15</string>
              <key>CFBundlePackageType</key>
              <string>APPL</string>
              <key>NSHighResolutionCapable</key>
              <true/>
          </dict>
          </plist>
          EOF

          # Create DMG
          mkdir -p dmg_contents
          cp -R catsolle.app dmg_contents/
          ln -s /Applications dmg_contents/Applications
          hdiutil create -volname "catsolle" -srcfolder dmg_contents -ov -format UDZO catsolle-universal-macos.dmg

      - name: Upload DMG
        uses: actions/upload-artifact@v4
        with:
          name: catsolle-macos-dmg
          path: catsolle-universal-macos.dmg

  # ============================================
  # Linux Packages (deb, rpm, AppImage)
  # ============================================
  linux-packages:
    name: Linux Packages
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download Linux x64 artifact
        uses: actions/download-artifact@v4
        with:
          name: catsolle-x86_64-unknown-linux-gnu

      - name: Extract binary
        run: |
          mkdir -p extracted
          tar -xzf catsolle-x86_64-unknown-linux-gnu.tar.gz -C extracted

      - name: Install packaging tools
        run: |
          sudo apt-get update
          sudo apt-get install -y rpm

      - name: Create .deb package
        run: |
          mkdir -p pkg/DEBIAN
          mkdir -p pkg/usr/bin
          mkdir -p pkg/usr/share/applications
          mkdir -p pkg/usr/share/doc/catsolle

          cp extracted/catsolle pkg/usr/bin/
          chmod +x pkg/usr/bin/catsolle

          cat > pkg/DEBIAN/control << 'EOF'
          Package: catsolle
          Version: 0.1.0
          Section: utils
          Priority: optional
          Architecture: amd64
          Maintainer: catsolle
          Description: TUI SSH client with dual-pane file manager
           A terminal-based SSH client with integrated SFTP file manager,
           AI assistant, and session recording.
          EOF

          cat > pkg/usr/share/applications/catsolle.desktop << 'EOF'
          [Desktop Entry]
          Name=catsolle
          Comment=TUI SSH Client
          Exec=catsolle
          Terminal=true
          Type=Application
          Categories=Network;RemoteAccess;
          EOF

          dpkg-deb --build pkg catsolle_0.1.0_amd64.deb

      - name: Create .rpm package
        run: |
          mkdir -p rpmbuild/{BUILD,RPMS,SOURCES,SPECS,SRPMS}

          cat > rpmbuild/SPECS/catsolle.spec << 'EOF'
          Name:           catsolle
          Version:        0.1.0
          Release:        1%{?dist}
          Summary:        TUI SSH client with dual-pane file manager
          License:        MPL-2.0
          URL:            https://github.com/user/catsolle

          %description
          A terminal-based SSH client with integrated SFTP file manager,
          AI assistant, and session recording.

          %install
          mkdir -p %{buildroot}/usr/bin
          install -m 755 %{_sourcedir}/catsolle %{buildroot}/usr/bin/catsolle

          %files
          /usr/bin/catsolle
          EOF

          cp extracted/catsolle rpmbuild/SOURCES/
          rpmbuild --define "_topdir $(pwd)/rpmbuild" -bb rpmbuild/SPECS/catsolle.spec
          cp rpmbuild/RPMS/x86_64/*.rpm catsolle-0.1.0-1.x86_64.rpm || cp rpmbuild/RPMS/*/*.rpm catsolle-0.1.0-1.x86_64.rpm

      - name: Create AppImage
        run: |
          # Download appimagetool
          wget -q https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
          chmod +x appimagetool-x86_64.AppImage
          export APPIMAGE_EXTRACT_AND_RUN=1

          # Create AppDir structure
          mkdir -p catsolle.AppDir/usr/bin
          cp extracted/catsolle catsolle.AppDir/usr/bin/
          chmod +x catsolle.AppDir/usr/bin/catsolle

          # Create desktop file
          cat > catsolle.AppDir/catsolle.desktop << 'EOF'
          [Desktop Entry]
          Name=catsolle
          Exec=catsolle
          Icon=catsolle
          Type=Application
          Categories=Network;RemoteAccess;
          Terminal=true
          EOF

          # Create AppRun
          cat > catsolle.AppDir/AppRun << 'EOF'
          #!/bin/bash
          SELF=$(readlink -f "$0")
          HERE=${SELF%/*}
          exec "${HERE}/usr/bin/catsolle" "$@"
          EOF
          chmod +x catsolle.AppDir/AppRun

          # Create placeholder icon
          touch catsolle.AppDir/catsolle.png

          # Build AppImage
          ARCH=x86_64 ./appimagetool-x86_64.AppImage catsolle.AppDir catsolle-x86_64.AppImage

      - name: Upload packages
        uses: actions/upload-artifact@v4
        with:
          name: catsolle-linux-packages
          path: |
            catsolle_0.1.0_amd64.deb
            catsolle-0.1.0-1.x86_64.rpm
            catsolle-x86_64.AppImage

  # ============================================
  # Release: Create GitHub Release
  # ============================================
  release:
    name: Create Release
    needs: [build, windows-installer, macos-bundle, linux-packages]
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release files
        run: |
          mkdir -p release
          find artifacts -type f \( -name "*.tar.gz" -o -name "*.zip" -o -name "*.msi" -o -name "*.dmg" -o -name "*.deb" -o -name "*.rpm" -o -name "*.AppImage" \) -exec cp {} release/ \;
          ls -la release/

      - name: Generate checksums
        run: |
          cd release
          sha256sum * > SHA256SUMS.txt
          cat SHA256SUMS.txt

      - name: Determine version
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
            echo "prerelease=false" >> $GITHUB_OUTPUT
          else
            echo "version=nightly-$(date +%Y%m%d)-${GITHUB_SHA::7}" >> $GITHUB_OUTPUT
            echo "prerelease=true" >> $GITHUB_OUTPUT
          fi

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: ${{ steps.version.outputs.version }}
          prerelease: ${{ steps.version.outputs.prerelease }}
          generate_release_notes: true
          files: |
            release/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
